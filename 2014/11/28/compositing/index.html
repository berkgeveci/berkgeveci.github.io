<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Spatial Streaming and Compositing &middot; Berk Geveci
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="container content">
      <div class="masthead">
      <h3 class="masthead-title">
      <a href="/" title="Home">Berk Geveci</a>

      
        &nbsp;&nbsp;&nbsp;
        <small><a href="/about">About</a></small>
      
        &nbsp;&nbsp;&nbsp;
        <small><a href="/archive">Archive</a></small>
      
        &nbsp;&nbsp;&nbsp;
        <small><a href="/atom.xml">Feed</a></small>
      
      </h3>      
      </div>

      <div class="post">
  <h1 class="post-title">Spatial Streaming and Compositing</h1>
  <span class="post-date">28 Nov 2014</span>
  <p>In my <a href="/2014/11/26/streaming-space/">last blog</a>, I talked about
spatial streaming in VTK. The example I covered demonstrated how a pipeline
consisting of a structured data source and a contour filter can be streamed
in smaller chunks to create a collection of polydata objects, which can then
be rendered. The downside of this approach is that the entirety of the contour
geometry needs to be stored in memory for rendering. One way of getting
around this limitation is to stream into a view. Here is an example.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">vtk.numpy_interface</span> <span class="kn">import</span> <span class="n">dataset_adapter</span> <span class="k">as</span> <span class="n">dsa</span>
<span class="kn">from</span> <span class="nn">vtk.util.vtkAlgorithm</span> <span class="kn">import</span> <span class="n">VTKPythonAlgorithmBase</span>
<span class="kn">import</span> <span class="nn">vtk</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">class</span> <span class="nc">StreamExtents</span><span class="p">(</span><span class="n">VTKPythonAlgorithmBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">VTKPythonAlgorithmBase</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">nInputPorts</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inputType</span><span class="o">=</span><span class="s">&#39;vtkImageData&#39;</span><span class="p">,</span>
            <span class="n">nOutputPorts</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Contour</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkContourFilter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Contour</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateIndex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfBlocks</span> <span class="o">=</span> <span class="mi">20</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Mapper</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataMapper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Mapper</span><span class="o">.</span><span class="n">SetScalarRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">actor</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkActor</span><span class="p">()</span>
        <span class="n">actor</span><span class="o">.</span><span class="n">SetMapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Mapper</span><span class="p">)</span>

        <span class="n">ren</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkRenderer</span><span class="p">()</span>
        <span class="n">ren</span><span class="o">.</span><span class="n">AddActor</span><span class="p">(</span><span class="n">actor</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">RenWin</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkRenderWindow</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RenWin</span><span class="o">.</span><span class="n">AddRenderer</span><span class="p">(</span><span class="n">ren</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RenWin</span><span class="o">.</span><span class="n">Render</span><span class="p">()</span>
        <span class="n">ren</span><span class="o">.</span><span class="n">GetActiveCamera</span><span class="p">()</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RenWin</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
        <span class="c"># This allows us to stream into the view. OpenGL</span>
        <span class="c"># takes care of compositing using the z-buffer</span>
        <span class="c"># when Erase is set to off.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RenWin</span><span class="o">.</span><span class="n">EraseOff</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RenWin</span><span class="o">.</span><span class="n">DoubleBufferOff</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">RequestUpdateExtent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">inInfo</span><span class="p">,</span> <span class="n">outInfo</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">inInfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">GetInformationObject</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c"># Ask for the next extent.</span>
        <span class="n">info</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
            <span class="n">vtk</span><span class="o">.</span><span class="n">vtkStreamingDemandDrivenPipeline</span><span class="o">.</span><span class="n">UPDATE_NUMBER_OF_PIECES</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfBlocks</span><span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
            <span class="n">vtk</span><span class="o">.</span><span class="n">vtkStreamingDemandDrivenPipeline</span><span class="o">.</span><span class="n">UPDATE_PIECE_NUMBER</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UpdateIndex</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">RequestData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">inInfo</span><span class="p">,</span> <span class="n">outInfo</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">inInfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">GetInformationObject</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="n">dsa</span><span class="o">.</span><span class="n">WrapDataObject</span><span class="p">(</span><span class="n">vtk</span><span class="o">.</span><span class="n">vtkDataSet</span><span class="o">.</span><span class="n">GetData</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Contour</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">VTKObject</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Contour</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">contour</span> <span class="o">=</span> <span class="n">dsa</span><span class="o">.</span><span class="n">WrapDataObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Contour</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">())</span>
        <span class="n">rtdata</span> <span class="o">=</span> <span class="n">contour</span><span class="o">.</span><span class="n">PointData</span><span class="p">[</span><span class="s">&#39;RTData&#39;</span><span class="p">]</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">rtdata</span><span class="p">)</span>
        <span class="n">color</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UpdateIndex</span>
        <span class="n">contour</span><span class="o">.</span><span class="n">PointData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="s">&quot;color&quot;</span><span class="p">)</span>
        <span class="n">contour</span><span class="o">.</span><span class="n">PointData</span><span class="o">.</span><span class="n">SetActiveScalars</span><span class="p">(</span><span class="s">&quot;color&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Mapper</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">contour</span><span class="o">.</span><span class="n">VTKObject</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RenWin</span><span class="o">.</span><span class="n">Render</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">UpdateIndex</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfBlocks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c"># If we are not done, ask the pipeline to re-execute us.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UpdateIndex</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">request</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
                <span class="n">vtk</span><span class="o">.</span><span class="n">vtkStreamingDemandDrivenPipeline</span><span class="o">.</span><span class="n">CONTINUE_EXECUTING</span><span class="p">(),</span>
                <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Stop execution</span>
            <span class="n">request</span><span class="o">.</span><span class="n">Remove</span><span class="p">(</span>
                <span class="n">vtk</span><span class="o">.</span><span class="n">vtkStreamingDemandDrivenPipeline</span><span class="o">.</span><span class="n">CONTINUE_EXECUTING</span><span class="p">())</span>
            <span class="c"># Reset for next potential execution.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UpdateIndex</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">w2i</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkWindowToImageFilter</span><span class="p">()</span>
            <span class="n">w2i</span><span class="o">.</span><span class="n">SetInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RenWin</span><span class="p">)</span>

            <span class="n">w</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPNGWriter</span><span class="p">()</span>
            <span class="n">w</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">w2i</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>
            <span class="n">w</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="s">&quot;composite1.png&quot;</span><span class="p">)</span>
            <span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

        <span class="k">return</span> <span class="mi">1</span>

<span class="n">w</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkRTAnalyticSource</span><span class="p">()</span>
<span class="n">w</span><span class="o">.</span><span class="n">SetWholeExtent</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">StreamExtents</span><span class="p">()</span>
<span class="n">s</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>

<span class="n">s</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span></code></pre></div>

<p>Note that this is very similar to the examples in the previous blog. The main
difference is that this algorithm is a sink rather than a filter and instead
of producing a polydata output which represents the contour, it produces an
image. For this, we create a rendering pipeline in the constructor and then
during each pipeline execution, we render the current contour geometry. Finally, we
save the output image after the last render. In skeleton code, this looks like
the following.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">RequestData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">inInfo</span><span class="p">,</span> <span class="n">outInfo</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">Mapper</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">contour</span><span class="o">.</span><span class="n">VTKObject</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">RenWin</span><span class="o">.</span><span class="n">Render</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">UpdateIndex</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfBlocks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c"># If we are not done, ask the pipeline to re-execute us.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateIndex</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">request</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
            <span class="n">vtk</span><span class="o">.</span><span class="n">vtkStreamingDemandDrivenPipeline</span><span class="o">.</span><span class="n">CONTINUE_EXECUTING</span><span class="p">(),</span>
            <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Stop execution</span>
        <span class="n">request</span><span class="o">.</span><span class="n">Remove</span><span class="p">(</span>
            <span class="n">vtk</span><span class="o">.</span><span class="n">vtkStreamingDemandDrivenPipeline</span><span class="o">.</span><span class="n">CONTINUE_EXECUTING</span><span class="p">())</span>
        <span class="c"># Reset for next potential execution.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateIndex</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">w2i</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkWindowToImageFilter</span><span class="p">()</span>
        <span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span></code></pre></div>

<p>The trick that makes this example work is in these two lines:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="bp">self</span><span class="o">.</span><span class="n">RenWin</span><span class="o">.</span><span class="n">EraseOff</span><span class="p">()</span>
<span class="bp">self</span><span class="o">.</span><span class="n">RenWin</span><span class="o">.</span><span class="n">DoubleBufferOff</span><span class="p">()</span></code></pre></div>

<p>When the <code>Erase</code> mode is enabled, the render window renders each time on
top of the same framebuffer and zbuffer without clearing them. OpenGL decides
to draw a particular pixel or not depending on the previous value of the z
buffer. If the old z value is smaller, it keeps the previous pixel.
Otherwise, it overwrites the pixel. This works perfectly because the object
we are rendering is opaque. Handling transparencly would require doing the
passes in a certain order and blending the pixels. I leave that to you as
an exercise. The output looks as follows. Click on the picture to see the
streaming in action.</p>

<figure>
<img src="/assets/composite1.png" alt="Animation" style="margin-left:auto; margin-right:auto" onclick='javascript:this.src="/assets/composite_anim.gif"'/>
</figure>

<p>This example was mainly for demonstration. The same can be achieved in VTK
without writing an algorithm. Here is the code.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">vtk</span>

<span class="n">w</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkRTAnalyticSource</span><span class="p">()</span>
<span class="n">w</span><span class="o">.</span><span class="n">SetWholeExtent</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkContourFilter</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>
<span class="n">c</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>

<span class="n">ps</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPieceScalars</span><span class="p">()</span>
<span class="n">ps</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>

<span class="n">mapper</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataMapper</span><span class="p">()</span>
<span class="n">mapper</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">ps</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>
<span class="n">mapper</span><span class="o">.</span><span class="n">SetNumberOfSubPieces</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">mapper</span><span class="o">.</span><span class="n">SetScalarRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

<span class="n">actor</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkActor</span><span class="p">()</span>
<span class="n">actor</span><span class="o">.</span><span class="n">SetMapper</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>

<span class="n">ren</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkRenderer</span><span class="p">()</span>
<span class="n">ren</span><span class="o">.</span><span class="n">AddActor</span><span class="p">(</span><span class="n">actor</span><span class="p">)</span>

<span class="n">renWin</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkRenderWindow</span><span class="p">()</span>
<span class="n">renWin</span><span class="o">.</span><span class="n">AddRenderer</span><span class="p">(</span><span class="n">ren</span><span class="p">)</span>
<span class="n">renWin</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
<span class="n">ren</span><span class="o">.</span><span class="n">GetActiveCamera</span><span class="p">()</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
<span class="n">renWin</span><span class="o">.</span><span class="n">Render</span><span class="p">()</span></code></pre></div>

<p>The only special thing in this example is the <code>mapper.SetNumberOfSubPieces(20)</code>
line which tells the mapper to stream its input in 20 steps. This uses the
same logic as our example in that the mapper does multiple render passes when
it is asked to render.</p>

<h2>Parallel Compositing</h2>

<p>The examples we covered so far are only one step away from parallel compositing
so we might as well cover that too. In general, parallel sort last compositing
involves rendering images with geometry local to each process, transferring
the frame and zbuffers over the network and then comparing the z values to decide
which pixels to keep from which framebuffer. For more details on compositing,
I recommend checking out some of the papers out there, for example
&quot;An Image Compositing Solution at Scale&quot; by Moreland et al. You should also check
out <a href="http://icet.sandia.gov/">IceT</a>, which has become the open-source reference
and production implementation used by many parallel tools including
VTK/ParaView.</p>

<p>Here is my simple two process example demonstrating compositing.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">vtk.numpy_interface</span> <span class="kn">import</span> <span class="n">dataset_adapter</span> <span class="k">as</span> <span class="n">dsa</span>
<span class="kn">import</span> <span class="nn">vtk</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>

<span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
<span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
<span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>

<span class="k">if</span> <span class="n">size</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&#39;This example needs 2 MPI processes&#39;</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">w</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkRTAnalyticSource</span><span class="p">()</span>
<span class="n">w</span><span class="o">.</span><span class="n">SetWholeExtent</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkContourFilter</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>
<span class="n">c</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>

<span class="n">ps</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPieceScalars</span><span class="p">()</span>
<span class="n">ps</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>

<span class="n">mapper</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyDataMapper</span><span class="p">()</span>
<span class="n">mapper</span><span class="o">.</span><span class="n">SetInputConnection</span><span class="p">(</span><span class="n">ps</span><span class="o">.</span><span class="n">GetOutputPort</span><span class="p">())</span>
<span class="c"># For streaming</span>
<span class="n">mapper</span><span class="o">.</span><span class="n">SetNumberOfSubPieces</span><span class="p">(</span><span class="mi">20</span><span class="o">/</span><span class="n">size</span><span class="p">)</span>
<span class="c"># For parallel execution</span>
<span class="n">mapper</span><span class="o">.</span><span class="n">SetNumberOfPieces</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
<span class="n">mapper</span><span class="o">.</span><span class="n">SetPiece</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span>
<span class="n">mapper</span><span class="o">.</span><span class="n">SetScalarRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

<span class="n">actor</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkActor</span><span class="p">()</span>
<span class="n">actor</span><span class="o">.</span><span class="n">SetMapper</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>

<span class="n">ren</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkRenderer</span><span class="p">()</span>
<span class="n">ren</span><span class="o">.</span><span class="n">AddActor</span><span class="p">(</span><span class="n">actor</span><span class="p">)</span>

<span class="n">renWin</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkRenderWindow</span><span class="p">()</span>
<span class="n">renWin</span><span class="o">.</span><span class="n">AddRenderer</span><span class="p">(</span><span class="n">ren</span><span class="p">)</span>
<span class="n">renWin</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
<span class="n">ren</span><span class="o">.</span><span class="n">GetActiveCamera</span><span class="p">()</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
<span class="c"># We need to do this manually because we want z buffer</span>
<span class="c"># values to be consistent across MPI ranks.</span>
<span class="n">ren</span><span class="o">.</span><span class="n">ResetCameraClippingRange</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">renWin</span><span class="o">.</span><span class="n">Render</span><span class="p">()</span>

<span class="c"># Grab the famebuffer</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkUnsignedCharArray</span><span class="p">()</span>
<span class="n">renWin</span><span class="o">.</span><span class="n">GetRGBACharPixelData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">599</span><span class="p">,</span> <span class="mi">599</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
<span class="n">rgba</span> <span class="o">=</span> <span class="n">dsa</span><span class="o">.</span><span class="n">vtkDataArrayToVTKArray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="c"># Grab the zbuffer</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
<span class="n">renWin</span><span class="o">.</span><span class="n">GetZbufferData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">599</span><span class="p">,</span> <span class="mi">599</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">dsa</span><span class="o">.</span><span class="n">vtkDataArrayToVTKArray</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

<span class="c"># Write individual framebuffers</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkImageData</span><span class="p">()</span>
<span class="n">i</span><span class="o">.</span><span class="n">SetDimensions</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">i</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">SetScalars</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="n">w</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPNGWriter</span><span class="p">()</span>
<span class="n">w</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="n">w</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="s">&quot;composite2_</span><span class="si">%d</span><span class="s">.png&quot;</span> <span class="o">%</span> <span class="n">rank</span><span class="p">)</span>
<span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

<span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c"># Receive the frame and zbuffers from rank 1</span>
    <span class="n">rgba2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">rgba</span><span class="p">)</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">comm</span><span class="o">.</span><span class="n">Recv</span><span class="p">([</span><span class="n">rgba2</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">CHAR</span><span class="p">],</span> <span class="n">source</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">77</span><span class="p">)</span>
    <span class="n">comm</span><span class="o">.</span><span class="n">Recv</span><span class="p">([</span><span class="n">z2</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">],</span> <span class="n">source</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">77</span><span class="p">)</span>
    <span class="c"># Compositing.</span>
    <span class="c"># Find where the zbuffer values of the remote</span>
    <span class="c"># image are smaller (pixels are closer).</span>
    <span class="n">loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">z2</span> <span class="o">&lt;</span> <span class="n">z</span><span class="p">)</span>
    <span class="c"># Use those locations to overwrite local pixels</span>
    <span class="c"># with remote pixels.</span>
    <span class="n">rgba</span><span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rgba2</span><span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span>

    <span class="c"># Write the composited image.</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkImageData</span><span class="p">()</span>
    <span class="n">i</span><span class="o">.</span><span class="n">SetDimensions</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">i</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">SetScalars</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="n">w</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPNGWriter</span><span class="p">()</span>
    <span class="n">w</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">w</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="s">&quot;composite2.png&quot;</span><span class="p">)</span>
    <span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">comm</span><span class="o">.</span><span class="n">Send</span><span class="p">([</span><span class="n">rgba</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">CHAR</span><span class="p">],</span> <span class="n">dest</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">77</span><span class="p">)</span>
    <span class="n">comm</span><span class="o">.</span><span class="n">Send</span><span class="p">([</span><span class="n">z</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">],</span> <span class="n">dest</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">77</span><span class="p">)</span></code></pre></div>

<p>There are a few interesting bits to this example. First, the following
sets up distributed processing pipeline as well as streaming:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># For streaming</span>
<span class="n">mapper</span><span class="o">.</span><span class="n">SetNumberOfSubPieces</span><span class="p">(</span><span class="mi">20</span><span class="o">/</span><span class="n">size</span><span class="p">)</span>
<span class="c"># For parallel execution</span>
<span class="n">mapper</span><span class="o">.</span><span class="n">SetNumberOfPieces</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
<span class="n">mapper</span><span class="o">.</span><span class="n">SetPiece</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span></code></pre></div>

<p>Note how each process is asked to process the piece with index <code>rank</code> among
a group of size <code>size</code>. In addition, each process is asked to stream using
<code>20/size</code> pieces. With 2 ranks, we still have 20 pieces total. The only
special thing we have to do for compositing to work is this.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># We need to do this manually because we want z buffer</span>
<span class="c"># values to be consistent across MPI ranks.</span>
<span class="n">ren</span><span class="o">.</span><span class="n">ResetCameraClippingRange</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span></code></pre></div>

<p>If we don&#39;t set a global clipping range, each rank will use clipping planes
based on local data which will lead to inconsistent zbuffer values (which
are normalized to 0-1).</p>

<p>Then we grab the frame and zbuffer with</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Grab the famebuffer</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkUnsignedCharArray</span><span class="p">()</span>
<span class="n">renWin</span><span class="o">.</span><span class="n">GetRGBACharPixelData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">599</span><span class="p">,</span> <span class="mi">599</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
<span class="n">rgba</span> <span class="o">=</span> <span class="n">dsa</span><span class="o">.</span><span class="n">vtkDataArrayToVTKArray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="c"># Grab the zbuffer</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
<span class="n">renWin</span><span class="o">.</span><span class="n">GetZbufferData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">599</span><span class="p">,</span> <span class="mi">599</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">dsa</span><span class="o">.</span><span class="n">vtkDataArrayToVTKArray</span><span class="p">(</span><span class="n">z</span><span class="p">)</span></code></pre></div>

<p>Then transfer the buffer from rank 1 to 0 with</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c"># Receive the frame and zbuffers from rank 1</span>
    <span class="n">rgba2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">rgba</span><span class="p">)</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">comm</span><span class="o">.</span><span class="n">Recv</span><span class="p">([</span><span class="n">rgba2</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">CHAR</span><span class="p">],</span> <span class="n">source</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">77</span><span class="p">)</span>
    <span class="n">comm</span><span class="o">.</span><span class="n">Recv</span><span class="p">([</span><span class="n">z2</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">],</span> <span class="n">source</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">77</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">comm</span><span class="o">.</span><span class="n">Send</span><span class="p">([</span><span class="n">rgba</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">CHAR</span><span class="p">],</span> <span class="n">dest</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">77</span><span class="p">)</span>
    <span class="n">comm</span><span class="o">.</span><span class="n">Send</span><span class="p">([</span><span class="n">z</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">],</span> <span class="n">dest</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">77</span><span class="p">)</span></code></pre></div>

<p>Finally compositing is only 2 lines:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Compositing.</span>
    <span class="c"># Find where the zbuffer values of the remote</span>
    <span class="c"># image are smaller (pixels are closer).</span>
    <span class="n">loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">z2</span> <span class="o">&lt;</span> <span class="n">z</span><span class="p">)</span>
    <span class="c"># Use those locations to overwrite local pixels</span>
    <span class="c"># with remote pixels.</span>
    <span class="n">rgba</span><span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rgba2</span><span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span></code></pre></div>

<p>I leave it up to the reader as an exercise to extend this to more
than 2 ranks. The paper by Ken et al. describes common ways of doing
this including using a binary tree pattern.</p>

<p>Here are the 2 local images and the final image:</p>

<p><img src="/assets/composite3.png" alt="composite"></p>

<p>In a future blog, I will talk about block-based streaming. Until then,
happy coding.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2014/11/26/streaming-space/">
            Streaming in VTK : Spatial
            <small>26 Nov 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2014/09/05/vtk-python-algorithm/">
            vtkPythonAlgorithm is great
            <small>05 Sep 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/01/19/block-streaming/">
            Block-Based Streaming
            <small>19 Jan 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>


      <div class="footer">
        <p>
          <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
        </p>
      </div>
    </div>

  </body>
</html>
